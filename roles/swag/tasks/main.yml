- name: Move confs
  copy:
    src: "{{ item }}"
    dest: "{{ appdata_path }}/swag/config/nginx/proxy-confs/"
    mode: "0664" # To prevent unnessecary restart after the container has done its chmod
    owner: "{{ main_username }}"
    group: "{{ main_groupname }}"
  become: true
  register: confs
  with_fileglob:
    - confs/*

- name: Enable confs
  copy:
    src: "{{ appdata_path }}/swag/config/nginx/proxy-confs/{{ item }}.conf.sample"
    remote_src: yes
    dest: "{{ appdata_path }}/swag/config/nginx/proxy-confs/{{ item }}.conf"
    mode: "0664" # To prevent unnessecary restart after the container has done its chmod
    owner: "{{ main_username }}"
    group: "{{ main_groupname }}"
  become: true
  register: enabled
  with_items:
    - "{{ enabled_confs }}"

- name: Disable confs
  file:
    dest: "{{ appdata_path }}/swag/config/nginx/proxy-confs/{{ item }}.conf"
    state: absent
  register: disabled
  with_items:
    - "{{ disabled_confs }}"

- name: Check dns file
  stat:
    path: "{{ appdata_path }}/swag/config/dns-conf/cloudflare.ini"
  register: cf_ini

- name: Install swag dns file
  template:
    src: "files/cloudflare.ini"
    dest: "{{ appdata_path }}/swag/config/dns-conf/cloudflare.ini"
    mode: "600" # To prevent unnessecary nag in logs
    owner: "{{ main_username }}"
    group: "{{ main_groupname }}"
  become: true

- name: Restart swag
  when: confs.changed or cf_ini.changed or enabled.changed or disabled.changed
  shell:
    chdir: "{{ appdata_path }}/swag"
    cmd: "docker-compose down --remove-orphans && docker-compose rm && docker-compose pull && docker-compose -p swag up -d"
